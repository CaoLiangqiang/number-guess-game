<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ•°å­—å¯¹å†³ Pro - AIæ¨ç†æŒ‘æˆ˜</title>

    <!-- å¾®ä¿¡åˆ†äº«ä¼˜åŒ– - Open Graph -->
    <meta property="og:title" content="æ•°å­—å¯¹å†³ Pro - æ¥æŒ‘æˆ˜æˆ‘çš„æ¨ç†æé™ï¼">
    <meta property="og:description" content="æˆ‘å·²ç»æƒ³å¥½äº†4ä½æ•°å­—ï¼Œä½ æ•¢æ¥çŒœå—ï¼Ÿ">
    <meta property="og:type" content="website">

    <!-- å¾®ä¿¡ä¸“ç”¨ -->
    <meta name="wx:title" content="æ•°å­—å¯¹å†³ Pro">
    <meta name="wx:description" content="æŒ‘æˆ˜æœ€å¼ºAIï¼Œè§‚çœ‹æ¨ç†å…¨è¿‡ç¨‹">

    <!-- PWA -->
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiXHU2NTcwXHU1YjU5XHU1ZmIxXHU1OTI5IFBybyIsInNob3J0X25hbWUiOiJcdTY1NzBcdTViNTkiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBmMTcyYSIsInRoZW1lX2NvbG9yIjoiIzBmMTcyYSJ9">
    
    <!-- Tailwind CSS - ä½¿ç”¨ Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å›½å†…å­—ä½“CDNé•œåƒ -->
    <link href="https://fonts.loli.net/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: white;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Neon Effects */
        .neon-border {
            box-shadow: 0 0 5px theme('colors.indigo.500'), 0 0 20px theme('colors.indigo.500/50');
        }

        .neon-text {
            text-shadow: 0 0 10px rgba(99, 102, 241, 0.8);
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
            }

            50% {
                box-shadow: 0 0 40px rgba(99, 102, 241, 0.8);
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .animate-slide-in {
            animation: slideIn 0.5s ease-out;
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        /* Custom Inputs */
        .digit-input {
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(99, 102, 241, 0.3);
            color: white;
            transition: all 0.3s;
        }

        .digit-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
            transform: scale(1.05);
        }

        /* AI Thinking Terminal */
        .terminal {
            background: #0a0a0a;
            border: 1px solid #333;
            font-family: 'JetBrains Mono', monospace;
            position: relative;
            overflow: hidden;
        }

        .terminal::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: linear-gradient(to bottom, transparent 50%, rgba(0, 255, 0, 0.02) 50%);
            background-size: 100% 4px;
            pointer-events: none;
        }

        .terminal-line {
            opacity: 0;
            animation: fadeIn 0.3s forwards;
            line-height: 1.6;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.3);
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.5);
        }

        /* ç§»åŠ¨ç«¯å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            /* è°ƒæ•´å®¹å™¨å†…è¾¹è· */
            .glass {
                padding: 1rem !important;
                margin: 0.5rem !important;
            }
            
            /* è°ƒæ•´æ ‡é¢˜å¤§å° */
            h1 {
                font-size: 1.75rem !important;
            }
            
            h2 {
                font-size: 1.25rem !important;
            }
            
            /* è°ƒæ•´æŒ‰é’®å¤§å° - ç¡®ä¿è§¦æ§ç›®æ ‡ä¸å°äº44px */
            button {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* è°ƒæ•´è¾“å…¥æ¡† */
            input[type="text"] {
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
                min-height: 44px;
            }
            
            /* ç§˜å¯†æ•°å­—è¾“å…¥æ¡† */
            .digit-input, #s1, #s2, #s3, #s4, #g1, #g2, #g3, #g4, [id^="mpS"] {
                width: 3rem !important;
                height: 3rem !important;
                font-size: 1.25rem !important;
            }
            
            /* æ¸¸æˆç•Œé¢å¸ƒå±€è°ƒæ•´ */
            #gameScreen {
                grid-template-columns: 1fr !important;
            }
            
            /* éšè—AIæ€è€ƒé¢æ¿åœ¨ç§»åŠ¨ç«¯ */
            #aiThinkingPanel,
            #battleInfoPanel {
                display: none !important;
            }
            
            /* å†å²è®°å½•åŒºåŸŸ */
            .h-48 {
                height: 8rem !important;
            }
            
            /* æˆ¿é—´å·æ˜¾ç¤º */
            #displayRoomCode {
                font-size: 2rem !important;
            }
            
            /* ç©å®¶çŠ¶æ€å¡ç‰‡ */
            .grid-cols-2 {
                grid-template-columns: 1fr !important;
            }
            
            /* è°ƒæ•´header */
            header h1 {
                font-size: 1.5rem !important;
            }
            
            header .w-12 {
                width: 2.5rem !important;
                height: 2.5rem !important;
            }
        }

        /* å°å±å¹•æ‰‹æœºä¼˜åŒ– */
        @media (max-width: 375px) {
            .glass {
                padding: 0.75rem !important;
            }
            
            button {
                padding: 0.5rem 1rem !important;
                font-size: 0.875rem !important;
            }
        }

        /* æ¨ªå±æ¨¡å¼ */
        @media (max-height: 500px) and (orientation: landscape) {
            .glass {
                max-height: 90vh;
                overflow-y: auto;
            }
        }

        /* è§¦æ‘¸åé¦ˆä¼˜åŒ– */
        @media (hover: none) {
            button:active {
                transform: scale(0.98);
            }
        }

        /* å®‰å…¨åŒºåŸŸé€‚é…ï¼ˆiPhone X+ï¼‰ */
        @supports (padding-top: env(safe-area-inset-top)) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
        }
    </style>
</head>

<body class="antialiased">

    <!-- Background Grid -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none opacity-20">
        <div class="absolute inset-0"
            style="background-image: radial-gradient(circle at 1px 1px, white 1px, transparent 0); background-size: 40px 40px;">
        </div>
    </div>

    <div class="container mx-auto px-4 py-6 max-w-7xl relative z-10">

        <!-- Header -->
        <header class="text-center mb-8 animate-slide-in">
            <div class="inline-flex items-center gap-3 mb-2">
                <div
                    class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-2xl font-bold neon-border">
                    #</div>
                <h1 class="text-5xl font-bold neon-text tracking-tighter">æ•°å­—å¯¹å†³ <span
                        class="text-indigo-400 text-2xl align-top">PRO</span></h1>
            </div>
            <p class="text-slate-400 mt-2">AIæ·±åº¦æ¨ç† Â· å¯è§†åŒ–æ€è€ƒè¿‡ç¨‹ Â· å³å¼€å³ç©</p>
        </header>

        <!-- Main Menu -->
        <div id="mainMenu" class="glass rounded-3xl p-8 max-w-4xl mx-auto animate-slide-in">
            <div class="mb-8">
                <!-- PVC Mode - å”¯ä¸€æ¨¡å¼ -->
                <button onclick="game.startGame()"
                    class="w-full group relative overflow-hidden rounded-2xl bg-gradient-to-br from-indigo-600 to-purple-700 p-8 hover:scale-[1.02] transition-all duration-300 border border-white/10">
                    <div
                        class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjIiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xKSIvPjwvc3ZnPg==')] opacity-20">
                    </div>
                    <div class="relative z-10 flex items-center justify-between">
                        <div class="flex items-center gap-6">
                            <div class="text-6xl animate-float">ğŸ¤–</div>
                            <div class="text-left">
                                <h3 class="text-2xl font-bold mb-2">æŒ‘æˆ˜ AI</h3>
                                <p class="text-indigo-200">ä¸æœ€å¼ºç®—æ³•å¯¹å†³ï¼Œè§‚çœ‹AIæ€è€ƒå…¨è¿‡ç¨‹</p>
                            </div>
                        </div>
                        <div class="text-indigo-300 group-hover:translate-x-2 transition-transform">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                    </div>
                </button>

                <!-- Multiplayer Mode -->
                <button onclick="game.showMultiplayerLobby()"
                    class="w-full group relative overflow-hidden rounded-2xl bg-gradient-to-br from-emerald-600 to-teal-700 p-8 hover:scale-[1.02] transition-all duration-300 border border-white/10 mt-6">
                    <div
                        class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjIiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xKSIvPjwvc3ZnPg==')] opacity-20">
                    </div>
                    <div class="relative z-10 flex items-center justify-between">
                        <div class="flex items-center gap-6">
                            <div class="text-6xl animate-float">ğŸ‘¥</div>
                            <div class="text-left">
                                <h3 class="text-2xl font-bold mb-2">åŒäººè”æœº</h3>
                                <p class="text-emerald-200">ä¸å¥½å‹å®æ—¶å¯¹æˆ˜ï¼Œæ¯”æ‹¼æ¨ç†é€Ÿåº¦</p>
                            </div>
                        </div>
                        <div class="text-emerald-300 group-hover:translate-x-2 transition-transform">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>

            <div class="bg-slate-800/50 rounded-2xl p-6 border border-white/5">
                <h4 class="font-bold mb-4 text-indigo-300 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    æ¸¸æˆè§„åˆ™ï¼ˆå…è®¸é‡å¤æ•°å­—ï¼‰
                </h4>
                <div class="grid md:grid-cols-2 gap-4 text-sm text-slate-300">
                    <div class="space-y-2">
                        <p class="flex items-start gap-2"><span class="text-indigo-400 font-bold">1.</span>
                            ä½ å’ŒAIå„é€‰ä¸€ä¸ªå››ä½æ•°ï¼ˆ0-9å¯é‡å¤ï¼Œå¦‚ï¼š1122ã€0000ï¼‰</p>
                        <p class="flex items-start gap-2"><span class="text-indigo-400 font-bold">2.</span>
                            è½®æµçŒœæµ‹ï¼ŒAIä¼šå®æ—¶å±•ç¤ºæ€è€ƒè¿‡ç¨‹</p>
                    </div>
                    <div class="space-y-2">
                        <p class="flex items-start gap-2"><span class="text-indigo-400 font-bold">3.</span>
                            åé¦ˆæ˜¾ç¤º"ä½ç½®ä¸”æ•°å­—éƒ½å¯¹"çš„ä¸ªæ•°ï¼ˆ0-4ï¼‰</p>
                        <p class="flex items-start gap-2"><span class="text-indigo-400 font-bold">4.</span> æœ€å…ˆçŒœä¸­å¯¹æ–¹æ•°å­—è€…è·èƒœ
                        </p>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-indigo-500/10 rounded-lg border border-indigo-500/20">
                    <p class="text-xs text-indigo-300 flex items-center gap-2">
                        <span class="text-lg">ğŸ’¡</span>
                        <span>AIä½¿ç”¨ Minimax ç®—æ³•ï¼Œå¯è§†åŒ–å±•ç¤ºæ¯æ­¥æ¨ç†è¿‡ç¨‹</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Multiplayer Lobby -->
        <div id="multiplayerLobby" class="hidden glass rounded-3xl p-8 max-w-4xl mx-auto animate-slide-in">
            <!-- Header -->
            <div class="flex items-center gap-4 mb-8">
                <button onclick="game.showMainMenu()" class="flex items-center gap-2 text-slate-400 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    <span>è¿”å›</span>
                </button>
                <h2 class="text-2xl font-bold">è”æœºå¤§å…</h2>
            </div>

            <!-- Server Status Notice -->
            <div id="serverNotice" class="mb-6 p-4 bg-green-500/10 border border-green-500/30 rounded-xl">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">âœ…</span>
                    <div>
                        <h4 class="font-bold text-green-400 mb-1">è”æœºåŠŸèƒ½å·²å°±ç»ª</h4>
                        <p class="text-sm text-green-200/80">æœåŠ¡å™¨å·²è¿æ¥ï¼åˆ›å»ºæˆ¿é—´é‚€è¯·å¥½å‹ï¼Œæˆ–è¾“å…¥æˆ¿é—´å·åŠ å…¥å¯¹æˆ˜ã€‚</p>
                    </div>
                </div>
            </div>

            <!-- Create Room Section -->
            <div class="mb-8" id="createRoomSection">
                <button onclick="game.createRoom()" class="w-full group relative overflow-hidden rounded-2xl bg-gradient-to-br from-indigo-600 to-purple-700 p-8 hover:scale-[1.02] transition-all duration-300 border border-white/10">
                    <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjIiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xKSIvPjwvc3ZnPg==')] opacity-20"></div>
                    <div class="relative z-10 flex items-center justify-between">
                        <div class="flex items-center gap-6">
                            <div class="text-6xl animate-float">ğŸ®</div>
                            <div class="text-left">
                                <h3 class="text-2xl font-bold mb-2">åˆ›å»ºæˆ¿é—´</h3>
                                <p class="text-indigo-200">ç”Ÿæˆæˆ¿é—´å·ï¼Œé‚€è¯·å¥½å‹åŠ å…¥</p>
                            </div>
                        </div>
                        <div class="text-indigo-300 group-hover:translate-x-2 transition-transform">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </div>
                    </div>
                </button>
            </div>

            <!-- Join Room Section -->
            <div class="bg-slate-800/50 rounded-2xl p-6 border border-white/5" id="joinRoomSection">
                <h4 class="font-bold mb-4 text-emerald-300 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                    </svg>
                    åŠ å…¥æˆ¿é—´
                </h4>
                <div class="flex gap-4">
                    <input type="text" id="roomCodeInput" maxlength="6" placeholder="è¾“å…¥6ä½æˆ¿é—´å·"
                        class="flex-1 bg-slate-900/80 border-2 border-slate-700 rounded-xl px-6 py-4 text-center text-2xl font-bold tracking-widest text-white placeholder:text-slate-600 focus:outline-none focus:border-emerald-500 focus:shadow-lg focus:shadow-emerald-500/30 transition-all">
                    <button onclick="game.joinRoom()" class="px-8 py-4 bg-gradient-to-r from-emerald-600 to-teal-700 hover:from-emerald-700 hover:to-teal-800 rounded-xl font-bold shadow-lg transition-all transform hover:scale-[1.02]">
                        åŠ å…¥
                    </button>
                </div>
            </div>

            <!-- Quick Action -->
            <div class="mt-8 text-center">
                <p class="text-slate-400 mb-4">æƒ³è¦ç«‹å³å¼€å§‹æ¸¸æˆï¼Ÿ</p>
                <button onclick="game.showMainMenu(); setTimeout(() => game.startGame(), 100);" 
                    class="px-8 py-4 bg-gradient-to-r from-indigo-600 to-purple-700 hover:from-indigo-700 hover:to-purple-800 rounded-xl font-bold shadow-lg transition-all transform hover:scale-[1.02]">
                    ğŸ® å¼€å§‹å•æœºæ¸¸æˆ
                </button>
            </div>
        </div>

        <!-- Waiting Room -->
        <div id="waitingRoom" class="hidden glass rounded-3xl p-8 max-w-4xl mx-auto animate-slide-in">
            <!-- Header -->
            <div class="flex items-center gap-4 mb-8">
                <button onclick="game.showMultiplayerLobby()" class="flex items-center gap-2 text-slate-400 hover:text-white transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    <span>è¿”å›å¤§å…</span>
                </button>
            </div>

            <!-- Room Code Display -->
            <div class="text-center mb-8">
                <p class="text-slate-400 mb-2">æˆ¿é—´å·</p>
                <div class="flex items-center justify-center gap-4">
                    <div id="displayRoomCode" class="text-5xl font-bold mono tracking-widest text-emerald-400">------</div>
                    <button onclick="game.copyRoomCode()" class="p-3 bg-slate-800/80 hover:bg-slate-700 rounded-xl transition-colors border border-white/10" title="å¤åˆ¶æˆ¿é—´å·">
                        <svg class="w-6 h-6 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Secret Number Input -->
            <div class="bg-slate-800/50 rounded-2xl p-6 border border-white/10 mb-6">
                <h4 class="font-bold text-lg mb-4 text-center text-indigo-300">è®¾ç½®ä½ çš„ç§˜å¯†æ•°å­—</h4>
                <div class="flex justify-center gap-3 mb-4">
                    <input type="text" id="mpS1" maxlength="1" class="w-14 h-14 bg-slate-900/80 border-2 border-slate-700 rounded-xl text-center text-2xl font-bold text-white focus:outline-none focus:border-indigo-500 transition-all" placeholder="-"><input type="text" id="mpS2" maxlength="1" class="w-14 h-14 bg-slate-900/80 border-2 border-slate-700 rounded-xl text-center text-2xl font-bold text-white focus:outline-none focus:border-indigo-500 transition-all" placeholder="-"><input type="text" id="mpS3" maxlength="1" class="w-14 h-14 bg-slate-900/80 border-2 border-slate-700 rounded-xl text-center text-2xl font-bold text-white focus:outline-none focus:border-indigo-500 transition-all" placeholder="-"><input type="text" id="mpS4" maxlength="1" class="w-14 h-14 bg-slate-900/80 border-2 border-slate-700 rounded-xl text-center text-2xl font-bold text-white focus:outline-none focus:border-indigo-500 transition-all" placeholder="-">
                </div>
                <p class="text-xs text-slate-500 text-center">è¾“å…¥4ä½æ•°å­—ï¼ˆ0-9å¯é‡å¤ï¼‰ï¼Œå‡†å¤‡å¥½åç‚¹å‡»å‡†å¤‡æŒ‰é’®</p>
            </div>

            <!-- Player Status Cards -->
            <div class="grid grid-cols-2 gap-6 mb-8">
                <!-- Left: You -->
                <div class="bg-slate-800/50 rounded-2xl p-6 border border-white/10 text-center">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-3xl mx-auto mb-4">ğŸ‘¤</div>
                    <h4 class="font-bold text-lg mb-2">ä½ </h4>
                    <div id="playerReadyStatus" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-yellow-500/20 text-yellow-400 text-sm">
                        <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
                        <span id="playerStatusText">æœªå‡†å¤‡</span>
                    </div>
                    <button id="readyBtn" onclick="game.setPlayerReady()" class="mt-4 w-full px-4 py-2 bg-gradient-to-r from-emerald-600 to-teal-700 hover:from-emerald-700 hover:to-teal-800 rounded-xl font-semibold transition-all">
                        æˆ‘å‡†å¤‡å¥½äº†
                    </button>
                </div>

                <!-- Right: Opponent -->
                <div class="bg-slate-800/50 rounded-2xl p-6 border border-white/10 text-center">
                    <div class="w-16 h-16 rounded-full bg-slate-700 flex items-center justify-center text-3xl mx-auto mb-4">â³</div>
                    <h4 class="font-bold text-lg mb-2">å¯¹æ‰‹</h4>
                    <div id="guestStatus" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-700/50 text-slate-400 text-sm">
                        <span class="w-2 h-2 rounded-full bg-slate-500 animate-pulse"></span>
                        ç­‰å¾…åŠ å…¥
                    </div>
                </div>
            </div>

            <!-- Cancel Button -->
            <div class="text-center">
                <button onclick="game.cancelWaiting()" class="px-8 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-semibold transition-all">
                    å–æ¶ˆç­‰å¾…
                </button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="hidden grid lg:grid-cols-3 gap-6 animate-slide-in">

            <!-- Network Status Bar (è”æœºæ¨¡å¼æ˜¾ç¤º) -->
            <div id="networkStatusBar" class="hidden lg:col-span-3 flex justify-between items-center mb-4 px-4">
                <div class="flex items-center gap-2">
                    <span id="connectionIndicator" class="w-2 h-2 rounded-full bg-green-500"></span>
                    <span id="connectionText" class="text-sm text-slate-400">å·²è¿æ¥</span>
                </div>
                <div class="text-sm text-slate-400">
                    å»¶è¿Ÿ: <span id="pingValue" class="text-indigo-400">--</span>ms
                </div>
            </div>

            <!-- Left Panel: Player -->
            <div class="lg:col-span-1 glass rounded-3xl p-6 flex flex-col min-h-[600px]">
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-white/10">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center font-bold text-lg">
                            ä½ </div>
                        <div>
                            <div class="font-bold">ç©å®¶</div>
                            <div class="text-xs text-slate-400" id="displayPlayerStatus">è®¾ç½®ä¸­...</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-indigo-400" id="playerStepCount">0</div>
                        <div class="text-xs text-slate-500">æ­¥æ•°</div>
                    </div>
                </div>

                <!-- Secret Setup -->
                <div id="secretSetupPanel" class="mb-6">
                    <label class="block text-sm text-slate-300 mb-3 font-semibold">è®¾ç½®ä½ çš„ç§˜å¯†æ•°å­—</label>
                    <div class="flex gap-2 justify-center mb-4">
                        <input type="number" min="0" max="9"
                            class="digit-input w-14 h-14 text-center text-2xl font-bold rounded-xl" maxlength="1"
                            oninput="game.validateDigit(this)">
                        <input type="number" min="0" max="9"
                            class="digit-input w-14 h-14 text-center text-2xl font-bold rounded-xl" maxlength="1"
                            oninput="game.validateDigit(this)">
                        <input type="number" min="0" max="9"
                            class="digit-input w-14 h-14 text-center text-2xl font-bold rounded-xl" maxlength="1"
                            oninput="game.validateDigit(this)">
                        <input type="number" min="0" max="9"
                            class="digit-input w-14 h-14 text-center text-2xl font-bold rounded-xl" maxlength="1"
                            oninput="game.validateDigit(this)">
                    </div>
                    <button onclick="game.confirmSecret()"
                        class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 rounded-xl font-semibold transition-all shadow-lg shadow-indigo-500/30">ç¡®è®¤ç§˜å¯†æ•°å­—</button>
                </div>

                <!-- Guess Input -->
                <div id="guessInputPanel" class="hidden mb-6">
                    <label class="block text-sm text-slate-300 mb-3 font-semibold flex justify-between">
                        <span>è¾“å…¥çŒœæµ‹</span>
                        <span class="text-xs text-indigo-400" id="turnIndicatorText">ä½ çš„å›åˆ</span>
                    </label>
                    <div class="flex gap-2 justify-center mb-4">
                        <input type="number" id="g1" min="0" max="9"
                            class="digit-input w-14 h-14 text-center text-2xl font-bold rounded-xl" maxlength="1">
                        <input type="number" id="g2" min="0" max="9"
                            class="digit-input w-14 h-14 text-center text-2xl font-bold rounded-xl" maxlength="1">
                        <input type="number" id="g3" min="0" max="9"
                            class="digit-input w-14 h-14 text-center text-2xl font-bold rounded-xl" maxlength="1">
                        <input type="number" id="g4" min="0" max="9"
                            class="digit-input w-14 h-14 text-center text-2xl font-bold rounded-xl" maxlength="1">
                    </div>
                    <button onclick="game.submitGuess()" id="submitGuessBtn"
                        class="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 rounded-xl font-bold shadow-lg transition-all transform hover:scale-[1.02]">æäº¤çŒœæµ‹</button>
                </div>

                <!-- History -->
                <div class="flex-1 overflow-hidden flex flex-col min-h-[200px]">
                    <h4 class="text-xs font-semibold mb-3 text-slate-500 uppercase tracking-wider">çŒœæµ‹å†å²</h4>
                    <div id="playerHistory" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                        <div class="text-center text-slate-600 text-sm py-8">æš‚æ— è®°å½•</div>
                    </div>
                </div>
            </div>

            <!-- Middle Panel: AI Thinking / Battle Info -->
            <div class="lg:col-span-1 flex flex-col">
                <!-- AI æ€è€ƒé¢æ¿ï¼ˆå•æœºæ¨¡å¼æ˜¾ç¤ºï¼‰ -->
                <div id="aiThinkingPanel" class="glass rounded-3xl p-6 flex-1 border border-indigo-500/30">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-indigo-300 flex items-center gap-2">
                            <span class="relative flex h-3 w-3">
                                <span
                                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-indigo-500"></span>
                            </span>
                            AI æ€è€ƒä¸­...
                        </h3>
                        <span class="text-xs text-slate-500 mono" id="aiCalcTime">0ms</span>
                    </div>

                    <div class="terminal rounded-xl p-4 text-sm h-[400px] overflow-y-auto custom-scrollbar"
                        id="aiTerminal">
                        <div class="text-green-400 mb-2">> ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ</div>
                        <div class="text-slate-400 mb-2">> ç­‰å¾…æ¸¸æˆå¼€å§‹...</div>
                    </div>

                    <!-- AI Stats -->
                    <div class="mt-4 grid grid-cols-2 gap-3">
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="text-xs text-slate-500">å‰©ä½™å¯èƒ½æ€§</div>
                            <div class="text-xl font-bold text-indigo-400 mono" id="aiPossibilities">10000</div>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="text-xs text-slate-500">ä¿¡æ¯ç†µ</div>
                            <div class="text-xl font-bold text-purple-400 mono" id="aiEntropy">13.29</div>
                        </div>
                    </div>
                </div>

                <!-- å¯¹æˆ˜ä¿¡æ¯é¢æ¿ï¼ˆè”æœºæ¨¡å¼æ˜¾ç¤ºï¼‰ -->
                <div id="battleInfoPanel" class="hidden glass rounded-3xl p-6 flex-1 border border-indigo-500/30">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-indigo-300">å¯¹æˆ˜ä¿¡æ¯</h3>
                        <span class="text-xs text-slate-500" id="turnDisplay">ç­‰å¾…å¼€å§‹...</span>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-slate-800/50 rounded-lg">
                            <span class="text-sm text-slate-400">å½“å‰å›åˆ</span>
                            <span id="currentTurn" class="text-lg font-bold text-indigo-400">-</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-slate-800/50 rounded-lg">
                            <span class="text-sm text-slate-400">ä½ çš„æ­¥æ•°</span>
                            <span id="yourSteps" class="text-lg font-bold text-emerald-400">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-slate-800/50 rounded-lg">
                            <span class="text-sm text-slate-400">å¯¹æ‰‹æ­¥æ•°</span>
                            <span id="opponentSteps" class="text-lg font-bold text-pink-400">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Opponent (AI) -->
            <div class="lg:col-span-1 glass rounded-3xl p-6 flex flex-col min-h-[600px] border-pink-500/20">
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-white/10">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center font-bold text-lg">ğŸ¤–</div>
                        <div>
                            <div class="font-bold">AI å¯¹æ‰‹</div>
                            <div class="text-xs text-slate-400" id="opponentStatus">æ€è€ƒä¸­...</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-pink-400" id="opponentStepCount">0</div>
                        <div class="text-xs text-slate-500">æ­¥æ•°</div>
                    </div>
                </div>

                <!-- Opponent Secret Display (Blurred) -->
                <div class="mb-6 p-4 bg-slate-800/50 rounded-2xl border border-white/5 opacity-60">
                    <div class="text-xs text-slate-500 mb-2 text-center">AIçš„ç§˜å¯†æ•°å­—</div>
                    <div class="flex gap-2 justify-center blur-md select-none">
                        <div class="w-12 h-12 bg-slate-700 rounded-lg flex items-center justify-center text-xl font-bold">?</div>
                        <div class="w-12 h-12 bg-slate-700 rounded-lg flex items-center justify-center text-xl font-bold">?</div>
                        <div class="w-12 h-12 bg-slate-700 rounded-lg flex items-center justify-center text-xl font-bold">?</div>
                        <div class="w-12 h-12 bg-slate-700 rounded-lg flex items-center justify-center text-xl font-bold">?</div>
                    </div>
                </div>

                <!-- Opponent Action Area -->
                <div id="opponentActionArea" class="mb-6 h-[100px] flex items-center justify-center">
                    <div class="text-center text-slate-500" id="opponentIdleText">ç­‰å¾…AIè¡ŒåŠ¨...</div>
                    <div class="hidden flex-col items-center gap-2" id="opponentThinkingAnim">
                        <div class="flex gap-1">
                            <div class="w-2 h-2 bg-pink-500 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-pink-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-pink-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                        <span class="text-sm text-pink-400">æ­£åœ¨åˆ†æ...</span>
                    </div>
                </div>

                <!-- Opponent History -->
                <div class="flex-1 overflow-hidden flex flex-col min-h-[200px]">
                    <h4 class="text-xs font-semibold mb-3 text-slate-500 uppercase tracking-wider">AIçŒœæµ‹è®°å½•</h4>
                    <div id="opponentHistory" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                        <div class="text-center text-slate-600 text-sm py-8">ç­‰å¾…AIçŒœæµ‹...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Over Modal -->
        <div id="gameOverModal"
            class="hidden fixed inset-0 bg-black/90 backdrop-blur-xl z-50 flex items-center justify-center p-4">
            <div
                class="glass rounded-3xl p-8 max-w-lg w-full text-center border border-white/20 shadow-2xl transform scale-100 animate-slide-in">
                <div class="text-6xl mb-4" id="gameOverEmoji">ğŸ†</div>
                <h2 class="text-4xl font-bold mb-2 neon-text" id="gameOverTitle">æ¸¸æˆç»“æŸ</h2>
                <p class="text-slate-300 mb-6 text-lg" id="gameOverMessage"></p>

                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div class="bg-slate-800/80 rounded-2xl p-4 border border-indigo-500/30">
                        <div class="text-sm text-indigo-300 mb-1">ä½ çš„ç§˜å¯†</div>
                        <div class="text-3xl font-bold mono text-white" id="finalPlayerSecret">----</div>
                    </div>
                    <div class="bg-slate-800/80 rounded-2xl p-4 border border-pink-500/30">
                        <div class="text-sm text-pink-300 mb-1">AIç§˜å¯†</div>
                        <div class="text-3xl font-bold mono text-white" id="finalOpponentSecret">----</div>
                    </div>
                </div>

                <div class="flex gap-3 justify-center">
                    <button onclick="location.reload()"
                        class="px-8 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 rounded-xl font-bold shadow-lg transition-all transform hover:scale-105">
                        å†æ¥ä¸€å±€
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ==================== æ¸¸æˆé…ç½® ====================
        const GameConfig = {
            // ç¯å¢ƒæ£€æµ‹
            environment: (() => {
                const hostname = window.location.hostname;
                if (hostname.includes('github.io')) return 'github_pages';
                if (hostname.includes('netlify.app')) return 'netlify';
                if (hostname.includes('localhost') || hostname.includes('127.0.0.1')) return 'development';
                return 'production';
            })(),
            
            // WebSocketæœåŠ¡å™¨åœ°å€é…ç½®
            wsServers: {
                development: 'ws://localhost:8080',
                github_pages: 'wss://number-guess-game-bl5r.onrender.com',
                netlify: 'wss://number-guess-game-bl5r.onrender.com',
                production: 'wss://number-guess-game-bl5r.onrender.com'
            },
            
            // è·å–å½“å‰ç¯å¢ƒçš„WebSocketåœ°å€
            getWsServer() {
                return this.wsServers[this.environment] || this.wsServers.production;
            },
            
            // æ¸¸æˆè®¾ç½®
            gameSettings: {
                maxReconnectAttempts: 5,
                heartbeatInterval: 1000,
                turnTimeout: 60, // å›åˆè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
                roomCodeLength: 6
            }
        };

        // å¯¼å‡ºé…ç½®ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
        window.GameConfig = GameConfig;

        // ==================== WebSocketå®¢æˆ·ç«¯æ¨¡å— ====================
        class WebSocketClient {
            constructor(serverUrl) {
                this.serverUrl = serverUrl;
                this.ws = null;
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = GameConfig.gameSettings.maxReconnectAttempts;
                this.heartbeatInterval = null;
                this.messageHandlers = new Map();
                this.pendingMessages = [];
                
                // é‡è¿çŠ¶æ€å›è°ƒ
                this.onReconnectStatus = null;
                
                // å¼±ç½‘æ£€æµ‹ç›¸å…³
                this.networkQuality = 'good'; // 'good' | 'poor' | 'bad'
                this.pingHistory = [];
                this.adaptiveHeartbeatInterval = GameConfig.gameSettings.heartbeatInterval;
            }

            // è¿æ¥æœåŠ¡å™¨
            connect() {
                return new Promise((resolve, reject) => {
                    try {
                        this.ws = new WebSocket(this.serverUrl);

                        this.ws.onopen = () => {
                            this.isConnected = true;
                            // é‡è¿æˆåŠŸé€šçŸ¥
                            if (this.reconnectAttempts > 0 && this.onReconnectStatus) {
                                this.onReconnectStatus('success');
                            }
                            this.reconnectAttempts = 0;
                            this.startHeartbeat();
                            this.flushPendingMessages();
                            resolve();
                        };

                        this.ws.onmessage = (event) => {
                            const data = JSON.parse(event.data);
                            this.handleMessage(data);
                        };

                        this.ws.onclose = () => {
                            this.isConnected = false;
                            this.stopHeartbeat();
                            this.attemptReconnect();
                        };

                        this.ws.onerror = (error) => {
                            reject(error);
                        };
                    } catch (error) {
                        reject(error);
                    }
                });
            }

            // å¿ƒè·³æœºåˆ¶ï¼ˆä½¿ç”¨è‡ªé€‚åº”é—´éš”ï¼‰
            startHeartbeat() {
                this.heartbeatInterval = setInterval(() => {
                    if (this.isConnected) {
                        this.send({ type: 'ping', timestamp: Date.now() });
                        this.measureNetworkQuality();
                    }
                }, this.adaptiveHeartbeatInterval);
            }

            stopHeartbeat() {
                if (this.heartbeatInterval) {
                    clearInterval(this.heartbeatInterval);
                    this.heartbeatInterval = null;
                }
            }

            // å‘é€æ¶ˆæ¯
            send(message) {
                if (this.isConnected && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify(message));
                } else {
                    this.pendingMessages.push(message);
                }
            }

            // åˆ·æ–°å¾…å‘é€æ¶ˆæ¯
            flushPendingMessages() {
                while (this.pendingMessages.length > 0) {
                    const msg = this.pendingMessages.shift();
                    this.send(msg);
                }
            }

            // è‡ªåŠ¨é‡è¿ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
            attemptReconnect() {
                if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                    console.error('Max reconnection attempts reached');
                    if (this.onReconnectStatus) {
                        this.onReconnectStatus('failed');
                    }
                    return;
                }

                const delay = Math.pow(2, this.reconnectAttempts) * 1000;
                this.reconnectAttempts++;

                // é€šçŸ¥é‡è¿çŠ¶æ€
                if (this.onReconnectStatus) {
                    this.onReconnectStatus('reconnecting', this.reconnectAttempts, this.maxReconnectAttempts);
                }

                setTimeout(() => {
                    console.log(`Reconnecting... attempt ${this.reconnectAttempts}`);
                    this.connect().catch(() => {});
                }, delay);
            }

            // æ¶ˆæ¯å¤„ç†
            handleMessage(data) {
                const handler = this.messageHandlers.get(data.type);
                if (handler) {
                    handler(data);
                }
            }

            // æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨
            on(type, handler) {
                this.messageHandlers.set(type, handler);
            }

            // ==================== å¼±ç½‘æ£€æµ‹å’Œè‡ªé€‚åº”ä¼˜åŒ– ====================
            
            // ç½‘ç»œè´¨é‡æ£€æµ‹æ–¹æ³•
            measureNetworkQuality() {
                const startTime = Date.now();
                this.send({ type: 'ping', timestamp: startTime });
                
                // ç­‰å¾…pongå“åº”è®¡ç®—å»¶è¿Ÿ
                const checkPong = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'pong') {
                            const rtt = Date.now() - data.timestamp;
                            this.pingHistory.push(rtt);
                            
                            // åªä¿ç•™æœ€è¿‘10ä¸ªpingå€¼
                            if (this.pingHistory.length > 10) {
                                this.pingHistory.shift();
                            }
                            
                            // è®¡ç®—å¹³å‡å»¶è¿Ÿå’Œä¸¢åŒ…ç‡
                            const avgPing = this.pingHistory.reduce((a, b) => a + b, 0) / this.pingHistory.length;
                            const packetLoss = this.calculatePacketLoss();
                            
                            // åˆ¤æ–­ç½‘ç»œè´¨é‡
                            if (avgPing < 100 && packetLoss < 5) {
                                this.networkQuality = 'good';
                                this.adaptiveHeartbeatInterval = 1000;
                            } else if (avgPing < 300 && packetLoss < 15) {
                                this.networkQuality = 'poor';
                                this.adaptiveHeartbeatInterval = 2000;
                            } else {
                                this.networkQuality = 'bad';
                                this.adaptiveHeartbeatInterval = 5000;
                            }
                            
                            // æ›´æ–°å¿ƒè·³é—´éš”
                            this.stopHeartbeat();
                            this.startHeartbeat();
                            
                            // æ›´æ–°UIæ˜¾ç¤º
                            this.updateNetworkUI(avgPing, this.networkQuality);
                            
                            this.ws.removeEventListener('message', checkPong);
                        }
                    } catch (e) {
                        // å¿½ç•¥è§£æé”™è¯¯
                    }
                };
                
                this.ws.addEventListener('message', checkPong);
            }

            // è®¡ç®—ä¸¢åŒ…ç‡
            calculatePacketLoss() {
                // ç®€åŒ–è®¡ç®—ï¼Œå®é™…åº”è¯¥è·Ÿè¸ªå‘é€å’Œæ¥æ”¶çš„æ¶ˆæ¯åºåˆ—å·
                if (this.pingHistory.length < 5) return 0;
                
                // æ£€æµ‹å¼‚å¸¸é«˜çš„å»¶è¿Ÿä½œä¸ºä¸¢åŒ…æŒ‡æ ‡
                const avg = this.pingHistory.reduce((a, b) => a + b, 0) / this.pingHistory.length;
                const highPingCount = this.pingHistory.filter(p => p > avg * 2).length;
                return (highPingCount / this.pingHistory.length) * 100;
            }

            // æ›´æ–°ç½‘ç»œçŠ¶æ€UI
            updateNetworkUI(ping, quality) {
                const pingElement = document.getElementById('pingValue');
                const indicator = document.getElementById('connectionIndicator');
                
                if (pingElement) {
                    pingElement.textContent = Math.round(ping);
                }
                
                if (indicator) {
                    indicator.className = `w-2 h-2 rounded-full ${
                        quality === 'good' ? 'bg-green-500' : 
                        quality === 'poor' ? 'bg-yellow-500' : 'bg-red-500'
                    }`;
                }
            }

            // æ–­å¼€è¿æ¥
            disconnect() {
                this.stopHeartbeat();
                if (this.ws) {
                    this.ws.close();
                }
            }
        }

        // ==================== æˆ¿é—´ç®¡ç†ç³»ç»Ÿ ====================
        class RoomManager {
            constructor(wsClient) {
                this.wsClient = wsClient;
                this.currentRoom = null;
                this.isHost = false;
                this.playerId = this.generatePlayerId();
                this.isReady = false;
                this.secretNumber = '';

                this.setupMessageHandlers();
            }

            // ç”Ÿæˆç©å®¶ID
            generatePlayerId() {
                return 'player_' + Math.random().toString(36).substr(2, 9);
            }

            // ç”Ÿæˆ6ä½æˆ¿é—´å·
            generateRoomCode() {
                const chars = '0123456789ABCDEF';
                let code = '';
                for (let i = 0; i < 6; i++) {
                    code += chars[Math.floor(Math.random() * chars.length)];
                }
                return code;
            }

            // åˆ›å»ºæˆ¿é—´
            createRoom(roomCode) {
                this.isHost = true;
                this.currentRoom = {
                    code: roomCode,
                    hostId: this.playerId,
                    guestId: null,
                    hostReady: false,
                    guestReady: false
                };

                this.wsClient.send({
                    type: 'create_room',
                    roomCode: roomCode,
                    playerId: this.playerId
                });

                return roomCode;
            }

            // åŠ å…¥æˆ¿é—´
            joinRoom(roomCode) {
                this.isHost = false;
                this.wsClient.send({
                    type: 'join_room',
                    roomCode: roomCode.toUpperCase(),
                    playerId: this.playerId
                });
            }

            // ç¦»å¼€æˆ¿é—´
            leaveRoom() {
                if (this.currentRoom) {
                    this.wsClient.send({
                        type: 'leave_room',
                        roomCode: this.currentRoom.code,
                        playerId: this.playerId
                    });
                    this.currentRoom = null;
                    this.isHost = false;
                    this.isReady = false;
                    this.secretNumber = '';
                }
            }

            // è®¾ç½®ç§˜å¯†æ•°å­—å¹¶å‡†å¤‡
            setReady(secret) {
                this.secretNumber = secret;
                this.isReady = true;

                if (this.currentRoom) {
                    this.wsClient.send({
                        type: 'player_ready',
                        roomCode: this.currentRoom.code,
                        playerId: this.playerId,
                        secret: secret
                    });
                }
            }

            // è®¾ç½®æ¶ˆæ¯å¤„ç†å™¨
            setupMessageHandlers() {
                this.wsClient.on('room_created', (data) => {
                    console.log('Room created:', data);
                });

                this.wsClient.on('player_joined', (data) => {
                    console.log('Player joined:', data);
                    if (this.currentRoom) {
                        this.currentRoom.guestId = data.playerId;
                    }
                });

                this.wsClient.on('player_left', (data) => {
                    console.log('Player left:', data);
                    if (this.currentRoom) {
                        this.currentRoom.guestId = null;
                        this.currentRoom.guestReady = false;
                    }
                });

                this.wsClient.on('player_ready', (data) => {
                    console.log('Player ready:', data);
                    if (this.currentRoom) {
                        if (data.playerId === this.currentRoom.hostId) {
                            this.currentRoom.hostReady = true;
                        } else {
                            this.currentRoom.guestReady = true;
                        }
                    }
                });
            }
        }

        // ==================== ä¸»æ¸¸æˆç±» ====================
        class NumberGamePro {
            constructor(mode = 'single') {
                this.mode = mode; // 'single' | 'multiplayer'
                this.wsClient = null;
                this.roomManager = null;
                this.opponentStepCount = 0;

                this.playerSecret = '';
                this.opponentSecret = '';
                this.myTurn = false;
                this.gameState = 'setup'; // setup, playing, over
                this.stepCount = { player: 0, opponent: 0 };

                // AI State
                this.aiPossibleNumbers = [];
                this.aiLastGuess = '';
                this.aiThinking = false;

                this.init();
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„æˆ¿é—´ä¼šè¯
                this.checkAndShowReconnectDialog();
            }
            
            // æ£€æŸ¥å¹¶æ˜¾ç¤ºé‡è¿å¯¹è¯æ¡†
            checkAndShowReconnectDialog() {
                const savedSession = this.restoreRoomSession();
                if (savedSession) {
                    // å»¶è¿Ÿæ˜¾ç¤ºï¼Œç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
                    setTimeout(() => {
                        this.showReconnectDialog(savedSession);
                    }, 500);
                }
            }

            // è”æœºæ¨¡å¼åˆå§‹åŒ–æ–¹æ³•
            async initMultiplayer(wsUrl) {
                this.mode = 'multiplayer';
                this.wsClient = new WebSocketClient(wsUrl);
                this.roomManager = new RoomManager(this.wsClient);

                this.wsClient.on('game_start', (data) => this.handleGameStart(data));
                this.wsClient.on('turn_change', (data) => this.handleTurnChange(data));
                this.wsClient.on('guess_result', (data) => this.handleGuessResult(data));
                this.wsClient.on('game_over', (data) => this.handleGameOver(data));
                this.wsClient.on('opponent_guess', (data) => this.handleOpponentGuess(data));

                // è®¾ç½®é‡è¿çŠ¶æ€å›è°ƒ
                this.wsClient.onReconnectStatus = (status, attempt, maxAttempts) => {
                    switch (status) {
                        case 'reconnecting':
                            this.showReconnectingUI(attempt, maxAttempts);
                            break;
                        case 'success':
                            this.hideReconnectingUI();
                            break;
                        case 'failed':
                            this.showReconnectFailedUI();
                            break;
                    }
                };

                try {
                    await this.wsClient.connect();
                    return true;
                } catch (error) {
                    console.log('WebSocketè¿æ¥å¤±è´¥:', error);
                    return false;
                }
            }

            // æ˜¾ç¤ºé‡è¿UI
            showReconnectingUI(attempt, maxAttempts) {
                // å¦‚æœå·²å­˜åœ¨åˆ™å…ˆç§»é™¤
                this.hideReconnectingUI();
                
                const reconnectDiv = document.createElement('div');
                reconnectDiv.id = 'reconnectOverlay';
                reconnectDiv.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center';
                reconnectDiv.innerHTML = `
                    <div class="glass rounded-2xl p-8 text-center">
                        <div class="animate-spin w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                        <h3 class="text-xl font-bold mb-2">ç½‘ç»œä¸ç¨³å®š</h3>
                        <p class="text-slate-400">æ­£åœ¨å°è¯•é‡è¿... (${attempt}/${maxAttempts})</p>
                    </div>
                `;
                document.body.appendChild(reconnectDiv);
            }

            // éšè—é‡è¿UI
            hideReconnectingUI() {
                const overlay = document.getElementById('reconnectOverlay');
                if (overlay) {
                    overlay.remove();
                }
            }

            // æ˜¾ç¤ºé‡è¿å¤±è´¥UI
            showReconnectFailedUI() {
                this.hideReconnectingUI();
                const failedDiv = document.createElement('div');
                failedDiv.id = 'reconnectFailedOverlay';
                failedDiv.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center';
                failedDiv.innerHTML = `
                    <div class="glass rounded-2xl p-8 text-center max-w-md">
                        <div class="text-6xl mb-4">âš ï¸</div>
                        <h3 class="text-xl font-bold mb-2">è¿æ¥å¤±è´¥</h3>
                        <p class="text-slate-400 mb-6">æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•</p>
                        <button onclick="location.reload()" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 rounded-xl font-semibold">
                            é‡æ–°åŠ è½½
                        </button>
                    </div>
                `;
                document.body.appendChild(failedDiv);
            }

            init() {
                // Setup input navigation
                document.querySelectorAll('.digit-input').forEach((input, idx, inputs) => {
                    input.addEventListener('input', (e) => {
                        if (e.target.value.length === 1 && idx < inputs.length - 1) {
                            inputs[idx + 1].focus();
                        }
                    });
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Backspace' && e.target.value === '' && idx > 0) {
                            inputs[idx - 1].focus();
                        }
                        if (e.key === 'Enter') {
                            this.handleEnterKey();
                        }
                    });
                });
                
                // è®¾ç½®æ‰€æœ‰è¾“å…¥æ¡†çš„è‡ªåŠ¨è·³è½¬
                this.setupInputAutoJump();
            }

            handleEnterKey() {
                if (this.gameState === 'setup' && document.getElementById('secretSetupPanel').style.display !== 'none') {
                    this.confirmSecret();
                } else if (this.myTurn && this.gameState === 'playing') {
                    this.submitGuess();
                }
            }

            validateDigit(input) {
                if (input.value.length > 1) input.value = input.value.slice(0, 1);
                if (input.value < 0) input.value = 0;
                if (input.value > 9) input.value = 9;
            }

            // ==================== Game Logic ====================

            startGame() {
                document.getElementById('mainMenu').classList.add('hidden');
                document.getElementById('gameScreen').classList.remove('hidden');

                // Init AI
                this.initAIPossibilities();
                this.updateAIThinking('ç­‰å¾…ç©å®¶è®¾ç½®ç§˜å¯†æ•°å­—...', 'info');
            }

            confirmSecret() {
                const inputs = document.querySelectorAll('#secretSetupPanel .digit-input');
                let secret = '';
                for (let input of inputs) {
                    if (input.value === '' || input.value.length !== 1) {
                        input.focus();
                        return;
                    }
                    secret += input.value;
                }

                this.playerSecret = secret;
                document.getElementById('secretSetupPanel').classList.add('hidden');
                document.getElementById('guessInputPanel').classList.remove('hidden');
                document.getElementById('displayPlayerStatus').textContent = 'å‡†å¤‡å®Œæˆ';

                // AI generates secret
                this.opponentSecret = this.generateRandomNumber();
                this.gameState = 'playing';
                this.myTurn = true;
                this.updateTurnUI();
                this.updateAIThinking('å·²ç”Ÿæˆç§˜å¯†æ•°å­—ï¼Œç­‰å¾…ç©å®¶çŒœæµ‹...', 'success');
            }

            submitGuess() {
                if (!this.myTurn || this.gameState !== 'playing') return;

                const inputs = [document.getElementById('g1'), document.getElementById('g2'),
                    document.getElementById('g3'), document.getElementById('g4')];
                let guess = '';
                for (let input of inputs) {
                    if (input.value === '' || input.value.length !== 1) {
                        input.focus();
                        return;
                    }
                    guess += input.value;
                }

                if (this.mode === 'single') {
                    // å•æœºæ¨¡å¼ï¼šæœ¬åœ°å¤„ç†
                    this.stepCount.player++;
                    document.getElementById('playerStepCount').textContent = this.stepCount.player;

                    // Calculate feedback locally
                    const correct = this.calculateMatch(guess, this.opponentSecret);
                    this.addToHistory('player', guess, correct);
                    this.addTerminalLine(`ä½ çŒœæµ‹: ${guess} -> åé¦ˆ: ${correct}/4`, 'player');

                    if (correct === 4) {
                        this.endGame('player', `ä½ åœ¨ç¬¬${this.stepCount.player}æ­¥çŒœä¸­äº†AIçš„æ•°å­—ï¼`);
                    } else {
                        inputs.forEach(i => i.value = '');
                        this.myTurn = false;
                        this.updateTurnUI();
                        setTimeout(() => this.aiTurn(), 1000);
                    }
                } else {
                    // è”æœºæ¨¡å¼ï¼šå‘é€åˆ°æœåŠ¡å™¨
                    this.wsClient.send({
                        type: 'submit_guess',
                        roomCode: this.roomManager.currentRoom.code,
                        playerId: this.roomManager.playerId,
                        guess: guess
                    });

                    // æœ¬åœ°å…ˆæ˜¾ç¤ºï¼ˆé¢„æµ‹æ€§æ¸²æŸ“ï¼‰
                    this.stepCount.player++;
                    document.getElementById('playerStepCount').textContent = this.stepCount.player;
                    this.addToHistory('player', guess, '?');
                    inputs.forEach(i => i.value = '');
                }
            }

            // ==================== AI Logic (Minimax) ====================

            initAIPossibilities() {
                this.aiPossibleNumbers = [];
                for (let i = 0; i < 10000; i++) {
                    this.aiPossibleNumbers.push(i.toString().padStart(4, '0'));
                }
                document.getElementById('aiPossibilities').textContent = '10000';
                document.getElementById('aiEntropy').textContent = '13.29';
            }

            generateRandomNumber() {
                return Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            }

            calculateMatch(guess, target) {
                let correct = 0;
                for (let i = 0; i < 4; i++) {
                    if (guess[i] === target[i]) correct++;
                }
                return correct;
            }

            async aiTurn() {
                if (this.gameState !== 'playing') return;

                this.aiThinking = true;
                document.getElementById('opponentIdleText').classList.add('hidden');
                document.getElementById('opponentThinkingAnim').classList.remove('hidden');
                document.getElementById('opponentStatus').textContent = 'æ·±åº¦æ¨ç†ä¸­...';

                this.addTerminalLine(`\n=== ç¬¬ ${this.stepCount.opponent + 1} è½®æ€è€ƒ ===`, 'header');

                const startTime = performance.now();

                // If first move, use optimal probing strategy
                let bestGuess;
                if (this.stepCount.opponent === 0) {
                    bestGuess = '0011'; // Optimal first guess for duplicate-allowed version
                    this.addTerminalLine('åˆå§‹æ­¥éª¤ï¼šä½¿ç”¨å¯å‘å¼å¼€å±€ 0011', 'info');
                    this.addTerminalLine('ç­–ç•¥ï¼šå‡åŒ€åˆ†å‰²æ•°å­—ç©ºé—´', 'info');
                } else {
                    // Filter possibilities based on last feedback
                    const lastGuess = this.aiLastGuess;
                    const lastFeedback = this.getLastFeedback();

                    this.addTerminalLine(`è¿‡æ»¤ï¼šæ’é™¤ä¸ç¬¦åˆ ${lastGuess} -> ${lastFeedback} çš„æ•°å­—...`, 'process');

                    const beforeCount = this.aiPossibleNumbers.length;
                    this.aiPossibleNumbers = this.aiPossibleNumbers.filter(num =>
                        this.calculateMatch(lastGuess, num) === lastFeedback
                    );
                    const afterCount = this.aiPossibleNumbers.length;

                    this.addTerminalLine(`å¯èƒ½æ€§ç©ºé—´ï¼š${beforeCount} -> ${afterCount} (å‰©ä½™ ${((afterCount / beforeCount) * 100).toFixed(1)}%)`, 'success');

                    // Calculate entropy
                    const entropy = Math.log2(afterCount).toFixed(2);
                    document.getElementById('aiPossibilities').textContent = afterCount;
                    document.getElementById('aiEntropy').textContent = entropy;

                    // Minimax selection
                    this.addTerminalLine('è®¡ç®—æœ€ä½³çŒœæµ‹ï¼ˆMinimaxç®—æ³•ï¼‰...', 'process');
                    bestGuess = this.selectMinimaxGuess();
                }

                const calcTime = (performance.now() - startTime).toFixed(0);
                document.getElementById('aiCalcTime').textContent = calcTime + 'ms';

                // "Thinking" delay for realism
                await this.delay(1500);

                this.aiLastGuess = bestGuess;
                this.stepCount.opponent++;
                document.getElementById('opponentStepCount').textContent = this.stepCount.opponent;

                // Show guess
                this.addToHistory('opponent', bestGuess, '?');
                this.addTerminalLine(`å†³ç­–ï¼šçŒœæµ‹ ${bestGuess}`, 'decision');

                document.getElementById('opponentThinkingAnim').classList.add('hidden');
                document.getElementById('opponentIdleText').classList.remove('hidden');

                // Calculate actual feedback
                const correct = this.calculateMatch(bestGuess, this.playerSecret);

                // Simulate "receiving" feedback
                await this.delay(500);
                this.addTerminalLine(`æ¥æ”¶åé¦ˆï¼š${correct}/4 ä½ç½®æ­£ç¡®`, correct === 4 ? 'win' : 'info');

                // Update history with feedback
                const historyDiv = document.getElementById('opponentHistory');
                const firstItem = historyDiv.firstElementChild;
                if (firstItem) {
                    firstItem.innerHTML = this.createHistoryItemHTML(bestGuess, correct);
                }

                if (correct === 4) {
                    this.endGame('opponent', `AIåœ¨ç¬¬${this.stepCount.opponent}æ­¥çŒœä¸­äº†ä½ çš„æ•°å­—ï¼`);
                } else {
                    this.myTurn = true;
                    this.updateTurnUI();
                }

                this.aiThinking = false;
            }

            selectMinimaxGuess() {
                // For performance, if possibilities < 100, check all; else sample
                const candidates = this.aiPossibleNumbers.length < 200 ?
                    this.aiPossibleNumbers :
                    this.aiPossibleNumbers.filter((_, i) => i % Math.ceil(this.aiPossibleNumbers.length / 150) === 0);

                let bestGuess = candidates[0];
                let minMaxSize = Infinity;
                let topChoices = [];

                // Evaluate top 5 candidates for display
                for (let i = 0; i < Math.min(candidates.length, 50); i++) {
                    const guess = candidates[i];
                    const distribution = new Array(5).fill(0); // 0-4 correct

                    // Calculate distribution of responses
                    for (const possible of this.aiPossibleNumbers) {
                        const match = this.calculateMatch(guess, possible);
                        distribution[match]++;
                    }

                    // Find max bucket size (worst case)
                    const maxBucket = Math.max(...distribution);
                    const score = maxBucket;

                    if (score < minMaxSize) {
                        minMaxSize = score;
                        bestGuess = guess;
                    }

                    if (i < 5) {
                        topChoices.push({
                            guess: guess,
                            maxBucket: maxBucket,
                            entropy: this.calculateEntropy(distribution)
                        });
                    }
                }

                // Also consider if bestGuess is in possibilities (prefer valid guesses)
                if (!this.aiPossibleNumbers.includes(bestGuess) && this.aiPossibleNumbers.length < 6) {
                    bestGuess = this.aiPossibleNumbers[0];
                }

                // Display top choices
                this.addTerminalLine('å€™é€‰è¯„ä¼°ï¼ˆTop 5ï¼‰ï¼š', 'info');
                topChoices.sort((a, b) => a.maxBucket - b.maxBucket);
                topChoices.slice(0, 3).forEach((choice, idx) => {
                    const bar = 'â–ˆ'.repeat(Math.floor((1 - choice.maxBucket / this.aiPossibleNumbers.length) * 10));
                    this.addTerminalLine(`  ${idx + 1}. ${choice.guess} | æœ€åæƒ…å†µ: ${choice.maxBucket} | ç†µ: ${choice.entropy.toFixed(2)} ${bar}`, 'info');
                });

                this.addTerminalLine(`é€‰æ‹©: ${bestGuess} (æœ€åæƒ…å†µä»… ${minMaxSize} ç§å¯èƒ½)`, 'decision');

                return bestGuess;
            }

            calculateEntropy(distribution) {
                let entropy = 0;
                const total = distribution.reduce((a, b) => a + b, 0);
                for (const count of distribution) {
                    if (count > 0) {
                        const p = count / total;
                        entropy -= p * Math.log2(p);
                    }
                }
                return entropy;
            }

            getLastFeedback() {
                // Get last feedback from opponent history
                const history = document.getElementById('opponentHistory').children;
                for (let item of history) {
                    const text = item.textContent;
                    const match = text.match(/(\d)\/4/);
                    if (match && match[1] !== '?') return parseInt(match[1]);
                }
                return -1;
            }

            updateAIThinking(message, type) {
                this.addTerminalLine(message, type);
            }

            addTerminalLine(text, type) {
                const terminal = document.getElementById('aiTerminal');
                const line = document.createElement('div');
                line.className = 'terminal-line mb-1';

                const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                line.innerHTML = `<span class="text-slate-600">[${timestamp}]</span> `;

                switch (type) {
                    case 'header':
                        line.innerHTML += `<span class="text-yellow-400 font-bold">${text}</span>`;
                        break;
                    case 'process':
                        line.innerHTML += `<span class="text-blue-400">${text}</span>`;
                        break;
                    case 'success':
                        line.innerHTML += `<span class="text-green-400">${text}</span>`;
                        break;
                    case 'decision':
                        line.innerHTML += `<span class="text-purple-400 font-bold">${text}</span>`;
                        break;
                    case 'win':
                        line.innerHTML += `<span class="text-pink-400 font-bold text-lg">${text}</span>`;
                        break;
                    case 'player':
                        line.innerHTML += `<span class="text-indigo-400">${text}</span>`;
                        break;
                    default:
                        line.innerHTML += `<span class="text-slate-300">${text}</span>`;
                }

                terminal.appendChild(line);
                terminal.scrollTop = terminal.scrollHeight;
            }

            // ==================== UI Helpers ====================

            addToHistory(player, guess, correct) {
                const historyDiv = document.getElementById(player + 'History');
                if (historyDiv.children.length === 1 && historyDiv.children[0].textContent.includes('æš‚æ— ') || historyDiv.children[0].textContent.includes('ç­‰å¾…')) {
                    historyDiv.innerHTML = '';
                }

                const entry = document.createElement('div');
                entry.className = 'flex justify-between items-center p-3 rounded-xl bg-slate-800/50 border border-white/5 animate-slide-in';
                entry.innerHTML = this.createHistoryItemHTML(guess, correct);
                historyDiv.insertBefore(entry, historyDiv.firstChild);
            }

            createHistoryItemHTML(guess, correct) {
                if (correct === '?') {
                    return `
                        <span class="mono text-xl font-bold tracking-widest text-slate-300">${guess}</span>
                        <span class="text-yellow-400 animate-pulse">ç­‰å¾…åé¦ˆ...</span>
                    `;
                }

                const dots = 'â—'.repeat(correct) + 'â—‹'.repeat(4 - correct);
                const colorClass = correct === 4 ? 'text-green-400' : correct >= 2 ? 'text-yellow-400' : 'text-slate-400';

                return `
                    <span class="mono text-xl font-bold tracking-widest text-white">${guess}</span>
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold ${colorClass}">${correct}/4</span>
                        <span class="text-sm tracking-widest ${colorClass}">${dots}</span>
                    </div>
                `;
            }

            updateTurnUI() {
                const indicator = document.getElementById('turnIndicatorText');
                const btn = document.getElementById('submitGuessBtn');

                if (this.myTurn) {
                    indicator.textContent = 'ä½ çš„å›åˆ - è¾“å…¥çŒœæµ‹';
                    indicator.className = 'text-xs text-emerald-400 font-bold animate-pulse';
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    document.getElementById('guessInputPanel').classList.remove('hidden');
                } else {
                    if (this.mode === 'single') {
                        indicator.textContent = 'ç­‰å¾…AI...';
                    } else {
                        indicator.textContent = 'ç­‰å¾…å¯¹æ‰‹...';
                    }
                    indicator.className = 'text-xs text-slate-500';
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // ==================== Multiplayer Handlers ====================

            // å¤„ç†æ¸¸æˆå¼€å§‹
            handleGameStart(data) {
                this.gameState = 'playing';
                this.myTurn = data.firstPlayer === this.roomManager.playerId;
                this.updateTurnUI();
                this.showBattleInfoPanel();
            }

            // å¤„ç†å›åˆåˆ‡æ¢
            handleTurnChange(data) {
                this.myTurn = data.currentPlayer === this.roomManager.playerId;
                this.updateTurnUI();
                document.getElementById('currentTurn').textContent = this.myTurn ? 'ä½ çš„å›åˆ' : 'å¯¹æ‰‹å›åˆ';
            }

            // å¤„ç†çŒœæµ‹ç»“æœ
            handleGuessResult(data) {
                const { playerId, guess, feedback } = data;

                if (playerId === this.roomManager.playerId) {
                    // æ›´æ–°è‡ªå·±çš„çŒœæµ‹å†å²
                    this.updateHistoryFeedback('player', guess, feedback);
                    document.getElementById('yourSteps').textContent = this.stepCount.player;
                } else {
                    // æ›´æ–°å¯¹æ‰‹çŒœæµ‹å†å²
                    this.opponentStepCount++;
                    this.addToHistory('opponent', guess, feedback);
                    document.getElementById('opponentSteps').textContent = this.opponentStepCount;
                }

                if (feedback === 4) {
                    const winner = playerId === this.roomManager.playerId ? 'player' : 'opponent';
                    const message = winner === 'player' ? 'ä½ èµ¢äº†ï¼' : 'å¯¹æ‰‹è·èƒœï¼';
                    this.endGame(winner, message);
                }
            }

            // å¤„ç†æ¸¸æˆç»“æŸ
            handleGameOver(data) {
                const { winner, message } = data;
                this.endGame(winner, message);
            }

            // å¤„ç†å¯¹æ‰‹çŒœæµ‹
            handleOpponentGuess(data) {
                // å¯é€‰ï¼šæ˜¾ç¤ºå¯¹æ‰‹æ­£åœ¨è¾“å…¥çš„åŠ¨ç”»æˆ–æç¤º
                console.log('Opponent is guessing...', data);
            }

            // æ˜¾ç¤ºå¯¹æˆ˜ä¿¡æ¯é¢æ¿
            showBattleInfoPanel() {
                document.getElementById('aiThinkingPanel').classList.add('hidden');
                document.getElementById('battleInfoPanel').classList.remove('hidden');
                document.getElementById('networkStatusBar').classList.remove('hidden');
            }

            // æ›´æ–°å†å²è®°å½•ä¸­çš„åé¦ˆ
            updateHistoryFeedback(player, guess, feedback) {
                const historyDiv = document.getElementById(player + 'History');
                const entries = historyDiv.querySelectorAll('.flex.justify-between');
                for (let entry of entries) {
                    const guessSpan = entry.querySelector('.mono');
                    if (guessSpan && guessSpan.textContent === guess) {
                        entry.innerHTML = this.createHistoryItemHTML(guess, feedback);
                        break;
                    }
                }
            }

            // ==================== Game Over ====================

            endGame(winner, message) {
                this.gameState = 'over';

                document.getElementById('gameOverModal').classList.remove('hidden');
                document.getElementById('gameOverMessage').textContent = message;

                if (winner === 'player') {
                    document.getElementById('gameOverEmoji').textContent = 'ğŸ‰';
                    document.getElementById('gameOverTitle').textContent = 'ä½ èµ¢äº†ï¼';
                    document.getElementById('gameOverTitle').className = 'text-4xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400';
                } else {
                    document.getElementById('gameOverEmoji').textContent = 'ğŸ¤–';
                    document.getElementById('gameOverTitle').textContent = 'AI è·èƒœ';
                    document.getElementById('gameOverTitle').className = 'text-4xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-rose-400';
                }

                document.getElementById('finalPlayerSecret').textContent = this.playerSecret;
                document.getElementById('finalOpponentSecret').textContent = this.opponentSecret;
            }

            // ==================== Multiplayer UI Navigation ====================

            showMultiplayerLobby() {
                document.getElementById('mainMenu').classList.add('hidden');
                document.getElementById('multiplayerLobby').classList.remove('hidden');
            }

            showMainMenu() {
                document.getElementById('multiplayerLobby').classList.add('hidden');
                document.getElementById('waitingRoom').classList.add('hidden');
                document.getElementById('mainMenu').classList.remove('hidden');
            }

            async createRoom() {
                // åˆå§‹åŒ–è”æœºæ¨¡å¼
                const wsUrl = GameConfig.getWsServer();
                const connected = await this.initMultiplayer(wsUrl);
                
                if (!connected) {
                    alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•');
                    return;
                }

                // Generate a random 6-character room code (0-9, A-F)
                const chars = '0123456789ABCDEF';
                let roomCode = '';
                for (let i = 0; i < 6; i++) {
                    roomCode += chars[Math.floor(Math.random() * chars.length)];
                }
                document.getElementById('displayRoomCode').textContent = roomCode;
                
                // åˆ›å»ºæˆ¿é—´
                this.roomManager.createRoom(roomCode);
                
                // è®¾ç½®æ¶ˆæ¯å¤„ç†å™¨
                this.setupRoomMessageHandlers();
                
                document.getElementById('multiplayerLobby').classList.add('hidden');
                document.getElementById('waitingRoom').classList.remove('hidden');
            }

            async joinRoom() {
                const roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
                if (roomCode.length !== 6 || !/^[0-9A-F]{6}$/.test(roomCode)) {
                    alert('è¯·è¾“å…¥6ä½æˆ¿é—´å·ï¼ˆæ•°å­—å’Œå¤§å†™å­—æ¯ï¼‰');
                    return;
                }
                
                // åˆå§‹åŒ–è”æœºæ¨¡å¼
                const wsUrl = GameConfig.getWsServer();
                const connected = await this.initMultiplayer(wsUrl);
                
                if (!connected) {
                    alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•');
                    return;
                }
                
                // åŠ å…¥æˆ¿é—´
                this.roomManager.joinRoom(roomCode);
                
                // è®¾ç½®æ¶ˆæ¯å¤„ç†å™¨
                this.setupRoomMessageHandlers();
                
                document.getElementById('multiplayerLobby').classList.add('hidden');
                document.getElementById('waitingRoom').classList.remove('hidden');
                document.getElementById('displayRoomCode').textContent = roomCode;
            }
            
            setupRoomMessageHandlers() {
                // æˆ¿é—´åˆ›å»ºæˆåŠŸ
                this.wsClient.on('room_created', (data) => {
                    console.log('Room created:', data);
                    this.updateWaitingRoomUI(data.room);
                });
                
                // åŠ å…¥æˆ¿é—´æˆåŠŸ
                this.wsClient.on('room_joined', (data) => {
                    console.log('Room joined:', data);
                    this.updateWaitingRoomUI(data.room);
                    
                    // å¦‚æœæ˜¯å®¢äººï¼Œæ˜¾ç¤ºå‡†å¤‡æŒ‰é’®
                    if (data.role === 'guest') {
                        document.getElementById('guestStatus').textContent = 'å·²åŠ å…¥';
                    }
                });
                
                // æœ‰ç©å®¶åŠ å…¥
                this.wsClient.on('player_joined', (data) => {
                    console.log('Player joined:', data);
                    document.getElementById('guestStatus').textContent = 'å·²åŠ å…¥ï¼Œç­‰å¾…å‡†å¤‡...';
                });
                
                // æ¸¸æˆå¼€å§‹
                this.wsClient.on('game_start', (data) => {
                    console.log('Game started:', data);
                    this.startMultiplayerGame(data);
                });
                
                // é”™è¯¯å¤„ç†
                this.wsClient.on('error', (data) => {
                    alert('é”™è¯¯: ' + data.message);
                    this.cancelWaiting();
                });
            }
            
            updateWaitingRoomUI(room) {
                // æ›´æ–°æˆ¿é—´çŠ¶æ€æ˜¾ç¤º
                if (room.guestId) {
                    document.getElementById('guestStatus').textContent = room.guestReady ? 'å·²å‡†å¤‡' : 'å·²åŠ å…¥ï¼Œç­‰å¾…å‡†å¤‡...';
                }
            }
            
            startMultiplayerGame(data) {
                // éšè—ç­‰å¾…æˆ¿é—´ï¼Œæ˜¾ç¤ºæ¸¸æˆç•Œé¢
                document.getElementById('waitingRoom').classList.add('hidden');
                document.getElementById('gameScreen').classList.remove('hidden');
                
                // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
                this.gameState = 'playing';
                this.myTurn = data.firstPlayer === this.roomManager.playerId;
                this.stepCount = { player: 0, opponent: 0 };
                this.opponentStepCount = 0;
                
                // æ˜¾ç¤ºå¯¹æˆ˜ä¿¡æ¯é¢æ¿
                this.showBattleInfoPanel();
                
                // æ›´æ–°UI
                this.updateTurnUI();
                document.getElementById('currentTurn').textContent = this.myTurn ? 'ä½ çš„å›åˆ' : 'å¯¹æ‰‹å›åˆ';
                document.getElementById('yourSteps').textContent = '0';
                document.getElementById('opponentSteps').textContent = '0';
                
                // æ¸…ç©ºå†å²è®°å½•
                document.getElementById('playerHistory').innerHTML = '<div class="text-center text-slate-500 py-8">æš‚æ— è®°å½•</div>';
                document.getElementById('aiHistory').innerHTML = '<div class="text-center text-slate-500 py-8">æš‚æ— è®°å½•</div>';
            }

            copyRoomCode() {
                const roomCode = document.getElementById('displayRoomCode').textContent;
                if (roomCode !== '------') {
                    navigator.clipboard.writeText(roomCode).then(() => {
                        alert('æˆ¿é—´å·å·²å¤åˆ¶: ' + roomCode);
                    }).catch(() => {
                        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                    });
                }
            }

            cancelWaiting() {
                // æ–­å¼€WebSocketè¿æ¥
                if (this.wsClient) {
                    this.wsClient.disconnect();
                    this.wsClient = null;
                }
                this.roomManager = null;
                this.mode = 'single';
                
                document.getElementById('waitingRoom').classList.add('hidden');
                document.getElementById('multiplayerLobby').classList.remove('hidden');
                
                // é‡ç½®å‡†å¤‡çŠ¶æ€UI
                document.getElementById('playerStatusText').textContent = 'æœªå‡†å¤‡';
                document.getElementById('playerReadyStatus').className = 'inline-flex items-center gap-2 px-4 py-2 rounded-full bg-yellow-500/20 text-yellow-400 text-sm';
                document.getElementById('readyBtn').disabled = false;
                document.getElementById('readyBtn').textContent = 'æˆ‘å‡†å¤‡å¥½äº†';
                document.getElementById('guestStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-slate-500 animate-pulse"></span>ç­‰å¾…åŠ å…¥';
                
                // æ¸…ç©ºç§˜å¯†æ•°å­—è¾“å…¥
                for (let i = 1; i <= 4; i++) {
                    document.getElementById('mpS' + i).value = '';
                }
            }
            
            setPlayerReady() {
                // è·å–ç§˜å¯†æ•°å­—
                const inputs = [document.getElementById('mpS1'), document.getElementById('mpS2'),
                               document.getElementById('mpS3'), document.getElementById('mpS4')];
                let secret = '';
                for (let input of inputs) {
                    if (input.value === '' || input.value.length !== 1 || !/^\d$/.test(input.value)) {
                        input.focus();
                        alert('è¯·è¾“å…¥å®Œæ•´çš„4ä½æ•°å­—');
                        return;
                    }
                    secret += input.value;
                }
                
                // ä¿å­˜ç§˜å¯†æ•°å­—
                this.playerSecret = secret;
                
                // ä¿å­˜æˆ¿é—´ä¼šè¯
                if (this.roomManager && this.roomManager.currentRoom) {
                    this.saveRoomSession(
                        this.roomManager.currentRoom.code,
                        this.roomManager.playerId,
                        secret,
                        this.roomManager.isHost
                    );
                }
                
                // å‘é€å‡†å¤‡æ¶ˆæ¯
                if (this.roomManager) {
                    this.roomManager.setReady(secret);
                    
                    // æ›´æ–°UI
                    document.getElementById('playerStatusText').textContent = 'å·²å‡†å¤‡';
                    document.getElementById('playerReadyStatus').className = 'inline-flex items-center gap-2 px-4 py-2 rounded-full bg-green-500/20 text-green-400 text-sm';
                    document.getElementById('readyBtn').disabled = true;
                    document.getElementById('readyBtn').textContent = 'ç­‰å¾…å¯¹æ‰‹...';
                    document.getElementById('readyBtn').classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
            
            // ==================== æˆ¿é—´ä¼šè¯ç®¡ç† ====================
            
            // ä¿å­˜æˆ¿é—´ä¼šè¯åˆ°localStorage
            saveRoomSession(roomCode, playerId, secret, isHost) {
                const session = {
                    roomCode,
                    playerId,
                    secret,
                    isHost,
                    timestamp: Date.now()
                };
                localStorage.setItem('numberGuess_roomSession', JSON.stringify(session));
            }
            
            // æ¢å¤æˆ¿é—´ä¼šè¯
            restoreRoomSession() {
                const sessionStr = localStorage.getItem('numberGuess_roomSession');
                if (!sessionStr) return null;
                
                try {
                    const session = JSON.parse(sessionStr);
                    // æ£€æŸ¥æ˜¯å¦è¶…è¿‡30åˆ†é’Ÿ
                    if (Date.now() - session.timestamp > 30 * 60 * 1000) {
                        localStorage.removeItem('numberGuess_roomSession');
                        return null;
                    }
                    return session;
                } catch (e) {
                    localStorage.removeItem('numberGuess_roomSession');
                    return null;
                }
            }
            
            // æ¸…é™¤æˆ¿é—´ä¼šè¯
            clearRoomSession() {
                localStorage.removeItem('numberGuess_roomSession');
            }
            
            // æ˜¾ç¤ºé‡è¿å¯¹è¯æ¡†
            showReconnectDialog(session) {
                const dialog = document.createElement('div');
                dialog.id = 'reconnectDialog';
                dialog.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center';
                dialog.innerHTML = `
                    <div class="glass rounded-2xl p-8 max-w-md text-center mx-4">
                        <div class="text-5xl mb-4">ğŸ®</div>
                        <h3 class="text-xl font-bold mb-2">æ£€æµ‹åˆ°æœªå®Œæˆçš„æ¸¸æˆ</h3>
                        <p class="text-slate-400 mb-6">æ‚¨æœ‰ä¸€ä¸ªè¿›è¡Œä¸­çš„æˆ¿é—´ï¼Œæ˜¯å¦é‡æ–°è¿æ¥ï¼Ÿ</p>
                        <div class="bg-slate-800/50 rounded-lg p-4 mb-6">
                            <div class="text-sm text-slate-500">æˆ¿é—´å·</div>
                            <div class="text-2xl font-bold mono text-emerald-400">${session.roomCode}</div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="game.cancelReconnect()" class="flex-1 px-4 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-semibold transition-all">
                                æ”¾å¼ƒ
                            </button>
                            <button onclick="game.reconnectToRoom('${session.roomCode}')" class="flex-1 px-4 py-3 bg-gradient-to-r from-emerald-600 to-teal-700 hover:from-emerald-700 hover:to-teal-800 rounded-xl font-semibold transition-all">
                                é‡æ–°è¿æ¥
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(dialog);
            }
            
            // å–æ¶ˆé‡è¿
            cancelReconnect() {
                const dialog = document.getElementById('reconnectDialog');
                if (dialog) dialog.remove();
                this.clearRoomSession();
            }
            
            // é‡æ–°è¿æ¥åˆ°æˆ¿é—´
            async reconnectToRoom(roomCode) {
                this.cancelReconnect();
                
                const session = this.restoreRoomSession();
                if (!session || session.roomCode !== roomCode) {
                    alert('ä¼šè¯å·²è¿‡æœŸ');
                    return;
                }
                
                // åˆå§‹åŒ–è”æœºæ¨¡å¼
                const wsUrl = GameConfig.getWsServer();
                const connected = await this.initMultiplayer(wsUrl);
                
                if (!connected) {
                    alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                    return;
                }
                
                // æ¢å¤playerId
                this.roomManager.playerId = session.playerId;
                
                // é‡æ–°åŠ å…¥æˆ¿é—´
                this.roomManager.joinRoom(roomCode);
                
                // è®¾ç½®æ¶ˆæ¯å¤„ç†å™¨
                this.setupRoomMessageHandlers();
                
                // æ¢å¤ç§˜å¯†æ•°å­—
                if (session.secret) {
                    this.playerSecret = session.secret;
                    // å¡«å……è¾“å…¥æ¡†
                    for (let i = 0; i < 4; i++) {
                        const input = document.getElementById('mpS' + (i + 1));
                        if (input) input.value = session.secret[i];
                    }
                    
                    // è‡ªåŠ¨å‘é€å‡†å¤‡
                    setTimeout(() => {
                        this.setPlayerReady();
                    }, 1000);
                }
                
                document.getElementById('multiplayerLobby').classList.add('hidden');
                document.getElementById('waitingRoom').classList.remove('hidden');
                document.getElementById('displayRoomCode').textContent = roomCode;
            }
            
            // ==================== è¾“å…¥è‡ªåŠ¨è·³è½¬ ====================
            
            setupInputAutoJump() {
                // ä¸ºæ‰€æœ‰æ•°å­—è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
                const inputGroups = [
                    ['s1', 's2', 's3', 's4'],
                    ['g1', 'g2', 'g3', 'g4'],
                    ['mpS1', 'mpS2', 'mpS3', 'mpS4']
                ];
                
                inputGroups.forEach(group => {
                    group.forEach((id, index) => {
                        const input = document.getElementById(id);
                        if (!input) return;
                        
                        // è¾“å…¥æ—¶è‡ªåŠ¨è·³è½¬
                        input.addEventListener('input', (e) => {
                            let val = e.target.value;
                            
                            // åªå…è®¸æ•°å­—
                            if (!/^\d*$/.test(val)) {
                                e.target.value = val.replace(/\D/g, '');
                                return;
                            }
                            
                            // è¾“å…¥ä¸€ä¸ªæ•°å­—åè·³è½¬åˆ°ä¸‹ä¸€ä¸ª
                            if (val.length === 1) {
                                const nextId = group[index + 1];
                                if (nextId) {
                                    const nextInput = document.getElementById(nextId);
                                    if (nextInput) nextInput.focus();
                                }
                            }
                        });
                        
                        // åˆ é™¤æ—¶è‡ªåŠ¨è·³å›
                        input.addEventListener('keydown', (e) => {
                            if (e.key === 'Backspace' && e.target.value === '') {
                                const prevId = group[index - 1];
                                if (prevId) {
                                    const prevInput = document.getElementById(prevId);
                                    if (prevInput) prevInput.focus();
                                }
                            }
                        });
                        
                        // ç²˜è´´å¤„ç†
                        input.addEventListener('paste', (e) => {
                            e.preventDefault();
                            const pasteData = e.clipboardData.getData('text');
                            const digits = pasteData.replace(/\D/g, '').split('');
                            
                            // ä»å½“å‰è¾“å…¥æ¡†å¼€å§‹å¡«å……
                            let currentIndex = index;
                            digits.forEach(digit => {
                                if (currentIndex < group.length) {
                                    const targetInput = document.getElementById(group[currentIndex]);
                                    if (targetInput) {
                                        targetInput.value = digit;
                                        currentIndex++;
                                    }
                                }
                            });
                            
                            // èšç„¦åˆ°æœ€åå¡«å……çš„è¾“å…¥æ¡†
                            if (currentIndex < group.length) {
                                const nextInput = document.getElementById(group[currentIndex]);
                                if (nextInput) nextInput.focus();
                            }
                        });
                    });
                });
            }
        }

        const game = new NumberGamePro();
    </script>
</body>

</html>
